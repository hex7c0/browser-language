"use strict";

var headerRegex = /([a-z]{2})/gi, all = {
    ab: "Abkhazian",
    af: "Afrikaans",
    an: "Aragonese",
    ar: "Arabic",
    as: "Assamese",
    az: "Azerbaijani",
    be: "Belarusian",
    bg: "Bulgarian",
    bn: "Bengali",
    bo: "Tibetan",
    br: "Breton",
    bs: "Bosnian",
    ca: "Catalan",
    ce: "Chechen",
    co: "Corsican",
    cs: "Czech",
    cu: "Church",
    cy: "Welsh",
    da: "Danish",
    de: "German",
    el: "Greek",
    en: "English",
    eo: "Esperanto",
    es: "Spanish",
    et: "Estonian",
    eu: "Basque",
    fa: "Persian",
    fi: "Finnish",
    fj: "Fijian",
    fo: "Faroese",
    fr: "French",
    fy: "Frisian",
    ga: "Irish",
    gd: "Gaelic",
    gl: "Galician",
    gv: "Manx",
    he: "Hebrew",
    hi: "Hindi",
    hr: "Croatian",
    ht: "Haitian",
    hu: "Hungarian",
    hy: "Armenian",
    id: "Indonesian",
    is: "Icelandic",
    it: "Italian",
    ja: "Japanese",
    jv: "Javanese",
    ka: "Georgian",
    kg: "Kongo",
    ko: "Korean",
    ku: "Kurdish",
    kw: "Cornish",
    ky: "Kirghiz",
    la: "Latin",
    lb: "Luxembourgish",
    li: "Limburgan",
    ln: "Lingala",
    lt: "Lithuanian",
    lv: "Latvian",
    mg: "Malagasy",
    mk: "Macedonian",
    mn: "Mongolian",
    mo: "Moldavian",
    ms: "Malay",
    mt: "Maltese",
    my: "Burmese",
    nb: "Norwegian",
    ne: "Nepali",
    nl: "Dutch",
    nn: "Norwegian",
    no: "Norwegian",
    oc: "Occitan",
    pl: "Polish",
    pt: "Portuguese",
    rm: "Raeto-Romance",
    ro: "Romanian",
    ru: "Russian",
    sc: "Sardinian",
    se: "Sami",
    sk: "Slovak",
    sl: "Slovenian",
    so: "Somali",
    sq: "Albanian",
    sr: "Serbian",
    sv: "Swedish",
    sw: "Swahili",
    tk: "Turkmen",
    tr: "Turkish",
    ty: "Tahitian",
    uk: "Ukrainian",
    ur: "Urdu",
    uz: "Uzbek",
    vi: "Vietnamese",
    vo: "Volapuk",
    yi: "Yiddish",
    zh: "Chinese"
};

function set(my, res, lang) {
    return res.cookie(my.cookie, lang, {
        domain: my.domain,
        path: my.path,
        maxAge: my.maxAge,
        httpOnly: my.httpOnly,
        secure: my.secure,
        signed: my.signed
    }), lang;
}

function detect(ll, header, lang) {
    if (header) for (var tmp, language = header.match(headerRegex), i = 0, ii = (language = language.filter(function(elem, pos, self) {
        return self.indexOf(elem.toLowerCase()) === pos;
    })).length; i < ii; ++i) if (tmp = lang[language[i]]) return tmp;
    return ll;
}

function language(opt) {
    var options = opt || Object.create(null), include = __dirname + "/min/lib/dictionary.js", lang = options.dictionary || require(include).LANG, my = {
        cookie: String(options.cookie || "lang"),
        domain: String(options.domain || ""),
        path: String(options.path || "/"),
        maxAge: Number(options.maxAge) || 31536e6,
        httpOnly: Boolean(options.httpOnly),
        secure: Boolean(options.secure),
        signed: Boolean(options.signed)
    };
    void 0 === lang._default ? lang = require(include).LANG : all[lang._default] || (console.error("language misconfigured"), 
    lang = require(include).LANG), process.env.lang = lang._default;
    var cookie = "cookies";
    if (my.signed && (cookie = "signedCookies"), "string" == typeof options.encryptionSecret) {
        var vault = require("cookie-encryption"), encryptionOptions = opt.encryptionOptions || Object.create(null);
        return vault = vault(options.encryptionSecret, {
            cookie: my.cookie,
            cipher: encryptionOptions.cipher,
            encoding: encryptionOptions.encoding,
            extra: encryptionOptions.extra,
            domain: encryptionOptions.domain || my.domain,
            path: encryptionOptions.path || my.path,
            maxAge: encryptionOptions.maxAge || my.maxAge,
            httpOnly: encryptionOptions.httpOnly || my.httpOnly,
            secure: encryptionOptions.secure || my.secure,
            signed: encryptionOptions.signed || my.signed
        }), function(req, res, next) {
            var biscotto;
            try {
                biscotto = vault.read(req);
            } catch (e) {
                biscotto = void 0;
            }
            if (biscotto && lang[biscotto]) return req[cookie][my.cookie] = biscotto, next();
            var ll = detect(lang._default, req.headers["accept-language"], lang);
            return req[cookie][my.cookie] = vault.write(req, ll), next();
        };
    }
    return function(req, res, next) {
        var biscotto = req[cookie];
        if (void 0 === biscotto) biscotto = Object.create(null); else if (lang[biscotto[my.cookie]]) return next();
        var ll = detect(lang._default, req.headers["accept-language"], lang);
        return biscotto[my.cookie] = set(my, res, ll), next();
    };
}

module.exports = language;
